---
title: "Random Forest"
author: "Xinyu Zhang"
date: "6/26/2020"
output: html_document
---
Reading data:
```{r}
library(dplyr)
#reading in listening test results
listener1 <- read.csv("Results_AK.csv", header = TRUE, sep = ";")
listener2 <- read.csv("Results_KS.csv", header = TRUE, sep = ";")
#renaming the two answers, removing column "Num"
SLP1 <- listener1 %>%
  dplyr::select(-Num) %>% 
  rename(Roughness = Answer1, Breathiness = Answer2)
SLP1$dummy <- paste(SLP1$Speaker, "-", SLP1$T)
#nrow(SLP1) #96

SLP2 <- listener2 %>%
  rename(Roughness = Answer1, Breathiness = Answer2)%>%
  dplyr::select(-Num)
SLP2$dummy <- paste(SLP2$Speaker, "-", SLP2$T)
#nrow(SLP2) #96

AVQI <- read.csv("AVQI_results_new.csv")
AVQI$dummy <- paste(AVQI$Speaker, "-", AVQI$T)
AVQI$Jitter <- as.numeric(levels(AVQI$Jitter))[AVQI$Jitter]

AVQI_RB_1 <- inner_join(SLP1,AVQI, by = "dummy")#retain only rows in both sets
#nrow(AVQI_BR_1) #96

AVQI_RB_2 <- inner_join(SLP2, AVQI, by = "dummy")#retain only rows in both sets
#nrow(AVQI_BR_2) #96

#join the two listening results tables by matching both Speaker and T
AVQI_RB <-rbind(AVQI_RB_1,AVQI_RB_2) %>% 
  dplyr::select(-A, -Speaker.x, -Speaker.y, -T.x, -T.x, -T.y, -Version, -Z)
#nrow(AVQI_RB) #192 (= 96 *2)
glimpse(AVQI_RB)

AVQI_R <- AVQI_RB %>% 
  dplyr::select(-Breathiness, - dummy, -AVQI, -Subject)

AVQI_B <- AVQI_RB %>% 
  dplyr::select(-Roughness, - dummy, -AVQI, -Subject)
```

Roughness:

Partitioning:
```{r}
set.seed(2008)
assignment <- sample(1:2, size = nrow(AVQI_R), prob = c(0.7, 3), replace = TRUE)

rough_train <- AVQI_R[assignment == 1, ]
rough_test <- AVQI_R[assignment == 2, ]
```

Single trees:
```{r}
library(rpart)
roughtree <- rpart(formula = Roughness ~ .,
                   data = rough_train,
                   method = "anova")
library(rpart.plot)
rpart.plot(x = roughtree, yesno = 2, type = 0, extra = 0)
```

HNR alone

Alternative tree:
```{r}
library(tree)
rough.tree = tree(formula = Roughness ~ ., data = rough_train) 
summary(rough.tree)
```
Variables: HNR, Shimmer, SHdB, Jitter

Plotting the tree:
```{r}
plot(rough.tree)
text(rough.tree, pretty = 0)
```

Pruning:
```{r}
cv.rough = cv.tree(rough.tree)
plot(cv.rough$size, cv.rough$dev, type = 'b')

prune.rough = prune.tree(rough.tree, best = 5)
plot(prune.rough)
text(prune.rough, pretty = 0)
```



Assessing the unpruned tree:
```{r}
yhat = predict(rough.tree, newdata = rough_test)
rough.test = rough_test$Roughness
plot(yhat, rough.test)
abline (0,1)
```

```{r}
sqrt(mean((yhat-rough.test)^2))
```

Bagging:
```{r}
library(randomForest)
set.seed(1745)
train.complete <- na.omit(rough_train)#removing NAs
rough.bag = randomForest(Roughness ~ ., data = train.complete, mtry = 7, importance = TRUE)
rough.bag
```

Assessing the bagged tree:
```{r}
test.complete <- na.omit(rough_test)
yhat.bag = predict(rough.bag, newdata = test.complete)
plot(yhat.bag, test.complete$Roughness)
abline (0,1)
```

```{r}
sqrt(mean((yhat.bag - test.complete$Roughness)^2))
```
^improved a little over the single tree

random forest:
```{r}
set.seed(0036)
rough.forest = randomForest(Roughness ~ ., data = train.complete, mtry = 2, importance = TRUE)
yhat.forest = predict(rough.forest, newdata = test.complete)
plot(yhat.forest, test.complete$Roughness)
abline(0,1)
```

rmse:
```{r}
sqrt(mean(yhat.forest - test.complete$Roughness)^2)
```
^improved upon bagged trees.

Importance of variables:
```{r}
importance(rough.forest)
```
Plotting the importance:
```{r}
varImpPlot(rough.forest)
```

Breathiness:

Partitioning:
```{r}
set.seed(0108)
assignment <- sample(1:2, size = nrow(AVQI_B), prob = c(0.7, 3), replace = TRUE)

breathy_train <- AVQI_B[assignment == 1, ]
breathy_test <- AVQI_B[assignment == 2, ]
```

Single tree:
```{r}
library(rpart)
breathytree <- rpart(formula = Breathiness ~ .,
                   data = breathy_train,
                   method = "anova")
library(rpart.plot)
rpart.plot(x = breathytree, yesno = 2, type = 0, extra = 0)
```
Tilt alone.

Alternative tree:
```{r}
library(tree)
breathy.tree = tree(formula = Breathiness ~ ., data = breathy_train) 
summary(breathy.tree)
```
Variables: Tilt, Shimmer, Jitter


Assessing the unpruned tree:
```{r}
yhat = predict(breathy.tree, newdata = breathy_test)
breathy.test = breathy_test$Breathiness
plot(yhat, breathy.test)
abline (0,1)
```

```{r}
sqrt(mean((yhat-rough.test)^2))
```




random forest:
```{r}
set.seed(0109)
btest.complete <- na.omit(breathy_test)
btrain.complete <- na.omit(breathy_train)
breathy.forest = randomForest(Breathiness ~ ., data = breathy_train, mtry = 2, importance = TRUE)
yhat.Bforest = predict(breathy.forest, newdata = btest.complete)
plot(yhat.Bforest, btest.complete$Breathiness)
abline(0,1)
```

rmse:
```{r}
sqrt(mean(yhat.Bforest - btest.complete$Breathiness)^2)
```

Importance of variables:
```{r}
importance(breathy.forest)
```


Plotting the importance:
```{r}
varImpPlot(breathy.forest)
```

trying out regressors to map out correlations:
(plotting Shimmer, CPPS, and ShdB since these three are the most relevant according to the random forest above)
```{r}
set.seed(1718)
df = na.omit(AVQI_RB)
regressorR = randomForest(x = df[6:12], y = df$Roughness)
saveRDS(regressorR, "roughness_regressor.dat")
```

Creating the structure of the input row for the regressor
```{r}
input <- function(CPPS, HNR, Jitter, Shimmer, ShdB, Slope, Tilt){
  row = data.frame (CPPS = 0, HNR = 0, Jitter = 0, Shimmer = 0, ShdB = 0, Slope = 0, Tilt = 0)
  row$CPPS[1] = CPPS
  row$HNR[1] = HNR
  row$Jitter[1] = Jitter
  row$Shimmer[1] = Shimmer
  row$ShdB[1] = ShdB
  row$Slope[1] = Slope
  row$Tilt[1] = Tilt
  return(row)
}
```

Defining ranges of input:
```{r}
Shimmer_seq = seq(min(df$Shimmer), max(df$Shimmer), 1)
CPPS_seq = seq(min(df$CPPS), max(df$CPPS), 1)
ShdB_seq = seq(min(df$ShdB), max(df$ShdB), 1)
```

Merging new dataset for plotting:
```{r}

```

Plots:
```{r}
ggplot()+
  geom_point()
```

